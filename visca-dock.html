<!DOCTYPE html>
<head>
<title>VISCA Test Page</title>
<meta charset="utf-8">

    <script>

    // Send a VISCA request, returning a promise.
    // - Call resolve() on successful transaction
    // - Call reject() on error
    var sendCount = 0;
    function send_visca_request( a_request ) {
        a_request['camera'] = document.getElementById("camera").value;
        a_request['sendCount'] = sendCount;
        sendCount = sendCount + 1;
        console.log( "Send VISCA request", a_request );

        return new Promise(
            function(resolve, reject) {
                var req = new XMLHttpRequest();

                // Originally had hostname = "localhost" here and in the Visca server.
                // But in Chrome (not Firefox) we see consistent attempts to
                // open TCP sessions in IPv6, getting RST,ACK (from server or Windows?)
                // Chrome waits about 250 msec and does another IPv6 SYN on a new port
                // After getting another RST,ACK, Chrome waits about 50 msec, then
                // finally starts the session on IPv4.
                // Using 127.0.0.1 eliminates the RST,ACKs and delays.
                var url = "http://127.0.0.1:8080/server";
                req.open('POST', url);
                req.setRequestHeader('Content-Type', 'application/json');

                req.onload = function() {
                    // 200 for web file; 0 for local file
                    // 404 for URL path not found; etc.
                    if (req.readyState === 4) {
                        if ((req.status === 200) || (req.status === 0)) {
                            var response = JSON.parse(req.response);
                            var status = response['status'];
                            if (status == null) {
                                reject('Invalid response from server');
                            }
                            else if (status != 'ok') {
                                reject(response.errors);
                            }
                            else {
                                resolve(response);
                            }
                        } else {
                            reject('Error from server: ' + req.statusText);
                        }
                    }
                };

                req.onerror = function() {
                    // Annoyingly, there seems to be nothing to tell us
                    // WHAT failed: no server, ...
                    // statusText is empty
                    // We may just declare persistent failure
                    reject('Network error');
                };

                req.send(JSON.stringify(a_request));
              });
    }

    //=========================================================================
    slew_threshold = 160;   // Longer than this is a slew command
    actionState = 'IDLE';
    slewTimer = null;
    request = {};

    function on_mouseenter( a_control ) {
        // Just change color and maybe mouse cursor to indicate clickable
        a_control.setAttribute("color", "green");
    }

    function on_mouseleave( a_control ) {
        if (actionState != 'IDLE') {
            // Clean up if mouse moved off button while pressed
            on_mouseup(a_control);
        }
        else {
            a_control.setAttribute("color", "white");
        }
    }

    function on_mousedown( a_control ) {
        switch (a_control.id) {
        case 'go_up':
            request['command'] = 'tilt';
            request['value'] = 'up';
            break;

        case 'go_down':
            request['command']= 'tilt';
            request['value'] = 'down';
            break;

        case 'go_left':
            request['command'] = 'pan';
            request['value'] = 'left';
            break;

        case 'go_right':
            request['command'] = 'pan';
            request['value'] = 'right';
            break;

        case 'zoom_in':
            request['command'] = 'zoom';
            request['value'] = 'in';
            break;

        case 'zoom_out':
            request['command'] = 'zoom';
            request['value'] = 'out';
            break;

        default:
            var str = "Error: unexpected control ID " + a_control.id;
            document.getElementById("showResults").innerHTML = str;
            console.log( str );
            return;
        }

        a_control.setAttribute("color", "blue");
        actionState = 'JOG';
		console.log('Started jog timer');
        slewTimer = window.setTimeout(on_threshold_reached, slew_threshold, a_control);
    }

    function on_mouseup( a_control ) {
		console.log('Stopping jog timer');
        window.clearTimeout(slewTimer);
        slewTimer = null;

        if (actionState == 'JOG') {
            if ((request['value'] == 'left') ||
                (request['value'] == 'up') ||
                (request['value'] == 'in'))
            {
                request['value'] = 1;
            }
            else {
                request['value'] = -1;
            }
        }
        else { 
            // Assume actionState == 'SLEW', and stop it
            request['value'] = 'stop';
        }

        send_visca_request(request)
            .then((response) => {
                console.log('mouseup success');
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed mouseup: ' + a_error;
            })
            .finally(() => {
                actionState = 'IDLE';
                // TODO: hover color, UNLESS called by mouseleave...
                a_control.setAttribute("color", "green");
            });
    }

    // Start slewing if button down beyond threshold time
    function on_threshold_reached(a_control) {
		console.log('Jog timer');
        a_control.setAttribute("color", "yellow");
        actionState = 'SLEW';
        send_visca_request(request)
            .then((response) => {
                console.log('start slew success');
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed start slew: ' + a_error;
            });
    }

    //==========================================================================
    jog_repeat = 250;   // Jog repeats if mouse held down this long
    actionState2 = 'IDLE';
    jogTimer = null;

    function on_mouseenter2( a_control ) {
        a_control.setAttribute("color", "green");
    }

    function on_mouseleave2( a_control ) {
        if (actionState2 != 'IDLE') {
            on_mouseup2(a_control);
        }
        else {
            a_control.setAttribute("color", "white");
        }
    }

    function on_mousedown2( a_control ) {
        var str;
        request = {};

        actionState2 = 'SLEW';
        switch (a_control.id) {
        case 'slew_up':
            request['command'] = 'tilt';
            request['value'] = 'up';
            break;

        case 'slew_down':
            request['command']= 'tilt';
            request['value'] = 'down';
            break;

        case 'slew_left':
            request['command'] = 'pan';
            request['value'] = 'left';
            break;

        case 'slew_right':
            request['command'] = 'pan';
            request['value'] = 'right';
            break;

        case 'jog_up':
            request['command'] = 'tilt';
            request['value'] = '1';
            actionState2 = 'JOG';
            break;

        case 'jog_down':
            request['command'] = 'tilt';
            request['value'] = '-1';
            actionState2 = 'JOG';
            break;

        case 'jog_left':
            request['command'] = 'pan';
            request['value'] = '1';
            actionState2 = 'JOG';
            break;

        case 'jog_right':
            request['command'] = 'pan';
            request['value'] = '-1';
            actionState2 = 'JOG';
            break;

        default:
            str = "Error: unexpected control ID " + a_control.id;
            document.getElementById("showResults").innerHTML = str;
            console.log( str );
            return;
        }

        a_control.setAttribute("color", "blue");
        if (actionState2 == 'JOG') {
            // Jog: send command, start timer to repeat jog
            send_visca_request(request)
                .then((response) => {
                    console.log('mousedown success, starting jog timer');
                    // Start the timer to repeat jog
                    jogTimer = window.setTimeout(on_timer2, jog_repeat, request)
                })
                .catch((a_error) => {
                    document.getElementById("showResults").innerHTML = 'Failed mousedown: ' + a_error;
                });
        }
        else {
            // slew: send start command
            send_visca_request(request)
                .then((response) => {
                    console.log('mousedown slew success');
                })
                .catch((a_error) => {
                    document.getElementById("showResults").innerHTML = 'Failed mousedown slew: ' + a_error;
                });
        }
    }

    function on_mouseup2( a_control ) {
        // Stop repeated jogs
        console.log('mouseup, stopping jog timer');
        window.clearTimeout(jogTimer);
        jogTimer = null;
        if (actionState2 == 'JOG') {
            actionState2 = 'IDLE';
            // TODO: hover color, UNLESS called by mouseleave...
            a_control.setAttribute("color", "green");
        }
        else if (actionState2 == 'SLEW') {
            // Stop slew
            request['value'] = 'stop';
            send_visca_request(request)
                .then((response) => {
                    console.log('mouseup2 success');
                })
                .catch((a_error) => {
                    document.getElementById("showResults").innerHTML = 'Failed mouseup2: ' + a_error;
                })
                .finally(() => {
                    actionState2 = 'IDLE';
                    // TODO: hover color, UNLESS called by mouseleave...
                    a_control.setAttribute("color", "green");
                });
        }
    }

    function on_timer2(a_request) {
        // Repeat jog command
        console.log('jog timer');
        if (actionState2 == 'JOG') {
			send_visca_request(request)
				.then((response) => {
					console.log('jog timer success. Restaring timer');
					jogTimer = window.setTimeout(on_timer2, jog_repeat, a_request)
				})
				.catch((a_error) => {
					document.getElementById("showResults").innerHTML = 'Failed mouse timer2: ' + a_error;
				});
		}
    }

    function do_read_position() {
        request['command'] = 'report';
        send_visca_request(request)
            .then((response) => {
                document.getElementById("showResults").innerHTML = 'pan=' + response['pan'] +
                    '  tilt=' + response['tilt'] + '  zoom=' + response['zoom'];

                // Stuff the values into the input fields
                document.getElementById("pan_val").innerHTML = response['pan'];
                document.getElementById("tilt_val").innerHTML = response['tilt'];
                document.getElementById("zoom_val").innerHTML = response['zoom'];
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed read position: ' + a_error;
            });
    }

    function do_read_version_info() {
        request['command'] = 'version-info';
        send_visca_request(request)
            .then((response) => {
                document.getElementById("showResults").innerHTML = 'vendor=' + response['vendor'] +
                    '  model=' + response['model'] + '  version=' + response['version'] +
                    '  maxsocket=' + response['max_socket'];
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed read version: ' + a_error;
            });
    }

    function do_show_preset() {
        request['command'] = 'go-preset';
        request['value'] = document.getElementById("preset_number").value;
        send_visca_request(request)
            .then((response) => {
                console.log('Set preset ' + request['value']);
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed show preset: ' + a_error;
            });
    }

    </script>
</head>

<body>

<div style="position:relative; top:0px; left:0px;">
    <label for="camera">Camera address:</label>
    <input id="camera" type="number" value="1">
    &nbsp;&nbsp;<button onclick="do_read_version_info()">Read Camera Info</button>
    &nbsp;&nbsp;<button onclick="do_read_position()">Read Position</button>
    <br><br>
    <label for="camera">Pan:</label>
    <input id="pan_val" type="number" value="1">
    <label for="camera">Tilt:</label>
    <input id="tilt_val" type="number" value="1">
    <label for="camera">Zoom:</label>
    <input id="zoom_val" type="number" value="1">
    <button onclick="do_move()">Move to</button>
    <br><br>
    <label for="camera">Preset Number:</label>
    <input id="preset_number" type="number" value="1">
    <button onclick="do_show_preset()">Show Preset</button>
    <button onclick="do_set_preset()">Set Preset</button>
    <br><br>
    <div id="showResults">
        y
    </div>
</div>

<!-- ============== first row =========================================================== -->
<div style="position:relative; top:100px; left:100px; width:250px; height:102px; background:#808080;">
<div style="position:absolute; top:17px; left:34px; width:34px; height:17px;">
    <svg id="go_up" width="34" height="17" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 17  L 17 0  L 34 17  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:41px; left:34px; width:34px; height:17px; font-size:13px; text-align: center;">
    move
</div>
<div style="position:absolute; top:34px; left:17px; width:17px; height:34px;">
    <svg id="go_left" width="17" height="34" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 17 34  L 0 17  L 17 0  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:34px; left:68px; width:17px; height:34px;">
    <svg id="go_right" width="17" height="34" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 17 17  L 0 34  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:68px; left:34px; width:34px; height:17px;">
    <svg id="go_down" width="34" height="17" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 17 17  L 34 0  Z" fill="currentColor"/>
    </svg>
</div>

<div style="position:absolute; top:17px; left:134px; width:34px; height:17px;">
    <svg id="zoom_in" width="34" height="17" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 17  L 17 0  L 34 17  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:41px; left:134px; width:34px; height:17px; font-size:13px; text-align: center;">
    zoom
</div>
<div style="position:absolute; top:68px; left:134px; width:34px; height:17px;">
    <svg id="zoom_out" width="34" height="17" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 17 17  L 34 0  Z" fill="currentColor"/>
    </svg>
</div>

</div>

<!-- ============== second row =========================================================== -->
<div style="position:relative; top:160px; left:100px; width:250px; height:102px; background:#808080;">
<div style="position:absolute; top:0px; left:34px; width:34px; height:17px;">
    <svg id="slew_up" width="34" height="17" color="white"
        onmousedown="on_mousedown2(this);" onmouseup="on_mouseup2(this);"
        onmouseenter="on_mouseenter2(this);" onmouseleave="on_mouseleave2(this);">
        <path d="M 0 17  L 17 0  L 34 17  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:17px; left:34px; width:34px; height:17px;">
    <svg id="jog_up" width="34" height="17" color="white"
        onmousedown="on_mousedown2(this);" onmouseup="on_mouseup2(this);"
        onmouseenter="on_mouseenter2(this);" onmouseleave="on_mouseleave2(this);">
        <path d="M 0 17  L 17 0  L 34 17  Z" fill="currentColor"/>
    </svg>
</div>

<div style="position:absolute; top:34px; left:0px; width:17px; height:34px;">
    <svg id="slew_left" width="17" height="34" color="white"
        onmousedown="on_mousedown2(this);" onmouseup="on_mouseup2(this);"
        onmouseenter="on_mouseenter2(this);" onmouseleave="on_mouseleave2(this);">
        <path d="M 17 34  L 0 17  L 17 0  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:34px; left:17px; width:17px; height:34px;">
    <svg id="jog_left" width="17" height="34" color="white"
        onmousedown="on_mousedown2(this);" onmouseup="on_mouseup2(this);"
        onmouseenter="on_mouseenter2(this);" onmouseleave="on_mouseleave2(this);">
        <path d="M 17 34  L 0 17  L 17 0  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:41px; left:34px; width:34px; height:17px; font-size:13px; text-align: center;">
    move
</div>
<div style="position:absolute; top:34px; left:68px; width:17px; height:34px;">
    <svg id="jog_right" width="17" height="34" color="white"
        onmousedown="on_mousedown2(this);" onmouseup="on_mouseup2(this);"
        onmouseenter="on_mouseenter2(this);" onmouseleave="on_mouseleave2(this);">
        <path d="M 0 0  L 17 17  L 0 34  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:34px; left:85px; width:17px; height:34px;">
    <svg id="slew_right" width="17" height="34" color="white"
        onmousedown="on_mousedown2(this);" onmouseup="on_mouseup2(this);"
        onmouseenter="on_mouseenter2(this);" onmouseleave="on_mouseleave2(this);">
        <path d="M 0 0  L 17 17  L 0 34  Z" fill="currentColor"/>
    </svg>
</div>

<div style="position:absolute; top:68px; left:34px; width:34px; height:17px;">
    <svg id="jog_down" width="34" height="17" color="white"
        onmousedown="on_mousedown2(this);" onmouseup="on_mouseup2(this);"
        onmouseenter="on_mouseenter2(this);" onmouseleave="on_mouseleave2(this);">
        <path d="M 0 0  L 17 17  L 34 0  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:85px; left:34px; width:34px; height:17px;">
    <svg id="slew_down" width="34" height="17" color="white"
        onmousedown="on_mousedown2(this);" onmouseup="on_mouseup2(this);"
        onmouseenter="on_mouseenter2(this);" onmouseleave="on_mouseleave2(this);">
        <path d="M 0 0  L 17 17  L 34 0  Z" fill="currentColor"/>
    </svg>
</div>

<div style="position:absolute; top:0px; left:134px; width:34px; height:17px;">
    <svg id="zoom_in" width="34" height="17" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 17  L 17 0  L 34 17  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:17px; left:134px; width:34px; height:17px;">
    <svg id="zoom_in" width="34" height="17" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 17  L 17 0  L 34 17  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:41px; left:134px; width:34px; height:17px; font-size:13px; text-align: center;">
    zoom
</div>
<div style="position:absolute; top:68px; left:134px; width:34px; height:17px;">
    <svg id="zoom_out" width="34" height="17" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 17 17  L 34 0  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:85px; left:134px; width:34px; height:17px;">
    <svg id="zoom_out" width="34" height="17" color="white"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);"
        onmouseenter="on_mouseenter(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 17 17  L 34 0  Z" fill="currentColor"/>
    </svg>
</div>
</div>

</body>
</html>
