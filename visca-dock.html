<!DOCTYPE html>
<head>
<title>VISCA Test Page</title>
<meta charset="utf-8">

    <script>

    // Originally had hostname = "localhost" here and in the Visca server.
    // But in Chrome (not Firefox) we see consistent attempts to
    // open TCP sessions in IPv6, getting RST,ACK (from server or Windows?)
    // Chrome waits about 250 msec and does another IPv6 SYN on a new port
    // After getting another RST,ACK, Chrome waits about 50 msec, then
    // finally starts the session on IPv4.
    // Using 127.0.0.1 eliminates the RST,ACKs and delays.
    var url = "http://127.0.0.1:8080/server";

    var request = {};
    var actionState = 'IDLE';
    var jog_repeat = 250;       // Jog repeats every jog_repeat msec if mouse held down
    var jogTimer = null;

    // Used by Save and Load presets
    var wait_for_preset = 2000; // msec to wait for camera movement
    var presetTimer = null;
    var presets = [];

    // Send a VISCA request, returning a promise.
    // - Call resolve() on successful transaction
    // - Call reject() on error
    var sendCount = 0;
    function send_visca_request( a_request ) {
        a_request['camera'] = document.getElementById("camera").value;
        a_request['sendCount'] = sendCount;
        sendCount = sendCount + 1;
        console.log( "Send VISCA request", a_request );

        return new Promise(
            function(resolve, reject) {
                var req = new XMLHttpRequest();
                req.open('POST', url);
                req.setRequestHeader('Content-Type', 'application/json');

                req.onload = function() {
                    // 200 for web file; 0 for local file
                    // 404 for URL path not found; etc.
                    if (req.readyState === 4) {
                        if ((req.status === 200) || (req.status === 0)) {
                            var response = JSON.parse(req.response);
                            var status = response['status'];
                            if (status == null) {
                                reject('Invalid response from server');
                            }
                            else if (status != 'ok') {
                                reject(response.errors);
                            }
                            else {
                                resolve(response);
                            }
                        } else {
                            reject('Error from server: ' + req.statusText);
                        }
                    }
                };

                req.onerror = function() {
                    // Annoyingly, there seems to be nothing to tell us
                    // WHAT failed: no server, ...
                    // statusText is empty
                    // We may just declare persistent failure
                    reject('Network error');
                };

                req.send(JSON.stringify(a_request));
              });
    }

    function on_mousedown( a_control ) {
        request = {};

        actionState = 'SLEW';
        switch (a_control.id) {
        case 'slew_up':
            request['command'] = 'tilt';
            request['value'] = 'up';
            break;

        case 'slew_down':
            request['command']= 'tilt';
            request['value'] = 'down';
            break;

        case 'slew_left':
            request['command'] = 'pan';
            request['value'] = 'left';
            break;

        case 'slew_right':
            request['command'] = 'pan';
            request['value'] = 'right';
            break;

        case 'slew_in':
            request['command'] = 'zoom';
            request['value'] = 'in';
            break;

        case 'slew_out':
            request['command'] = 'zoom';
            request['value'] = 'out';
            break;

        case 'jog_up':
            request['command'] = 'tilt';
            request['value'] = '1';
            actionState = 'JOG';
            break;

        case 'jog_down':
            request['command'] = 'tilt';
            request['value'] = '-1';
            actionState = 'JOG';
            break;

        case 'jog_left':
            request['command'] = 'pan';
            request['value'] = '1';
            actionState = 'JOG';
            break;

        case 'jog_right':
            request['command'] = 'pan';
            request['value'] = '-1';
            actionState = 'JOG';
            break;

        case 'jog_in':
            request['command'] = 'zoom';
            request['value'] = '1';
            actionState = 'JOG';
            break;

        case 'jog_out':
            request['command'] = 'zoom';
            request['value'] = '-1';
            actionState = 'JOG';
            break;

        default:
            var str = "Error: unexpected control ID " + a_control.id;
            document.getElementById("showResults").innerHTML = str;
            console.log( str );
            return;
        }

        // a_control.setAttribute("color", "blue");
        if (actionState == 'JOG') {
            // Jog: send command, start timer to repeat jog
            send_visca_request(request)
                .then((response) => {
                    if (actionState == 'JOG') {
                        // If button still active, start a timer to repeat jog.
                        // Normally the case, but a delay in the server may allow
                        // button-up before we get here.
                        console.log('jog success, start jog timer');
                        jogTimer = window.setTimeout(on_timer, jog_repeat, request);
                    }
                })
                .catch((a_error) => {
                    document.getElementById("showResults").innerHTML = 'Failed mousedown: ' + a_error;
                });
        }
        else {
            // slew: send start command
            send_visca_request(request)
                .then((response) => {
                    console.log('mousedown slew success');
                })
                .catch((a_error) => {
                    document.getElementById("showResults").innerHTML = 'Failed mousedown slew: ' + a_error;
                });
        }
    }

    function on_mouseup( a_control ) {
        if (actionState == 'JOG') {
            actionState = 'IDLE';
            console.log('mouseup stopping jog timer');
            window.clearTimeout(jogTimer);
            jogTimer = null;
        }
        else if (actionState == 'SLEW') {
            // Stop slew
            request['value'] = 'stop';
            send_visca_request(request)
                .then((response) => {
                    console.log('mouseup stopped slew');
                })
                .catch((a_error) => {
                    document.getElementById("showResults").innerHTML = 'Failed mouseup: ' + a_error;
                })
                .finally(() => {
                    actionState = 'IDLE';
                });
        }
    }

    function on_mouseleave(a_control) {
        if (actionState != 'IDLE') {
            // Terminate any commands in progress
            on_mouseup(a_control);
        }
    }

    function on_timer(a_request) {
        if (actionState == 'JOG') {
            console.log('timer: repeat jog');
			send_visca_request(a_request)
				.then((response) => {
					console.log('jog timer success. Restaring timer');
					jogTimer = window.setTimeout(on_timer, jog_repeat, a_request)
				})
				.catch((a_error) => {
					document.getElementById("showResults").innerHTML = 'Failed mouse timer: ' + a_error;
				});
		}
    }

    function do_read_position() {
        request = {};
        request['command'] = 'report';
        send_visca_request(request)
            .then((response) => {
                document.getElementById("showResults").innerHTML = 'pan=' + response['pan'] +
                    '  tilt=' + response['tilt'] + '  zoom=' + response['zoom'];

                // Stuff the values into the input fields
                document.getElementById("pan_val").value = response['pan'];
                document.getElementById("tilt_val").value = response['tilt'];
                document.getElementById("zoom_val").value = response['zoom'];
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed read position: ' + a_error;
            });
    }

    function do_read_version_info() {
        request = {};
        request['command'] = 'version-info';
        send_visca_request(request)
            .then((response) => {
                document.getElementById("showResults").innerHTML = 'vendor=' + response['vendor'] +
                    '  model=' + response['model'] + '  version=' + response['version'] +
                    '  maxsocket=' + response['max_socket'];
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed read version: ' + a_error;
            });
    }

    function do_show_preset() {
        request = {};
        request['command'] = 'go-preset';
        request['value'] = document.getElementById("preset_number").value;
        send_visca_request(request)
            .then((response) => {
                console.log('Set preset ' + request['value']);
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed show preset: ' + a_error;
            });
    }

    function do_set_preset() {
        request = {};
        request['command'] = 'set-preset';
        request['value'] = document.getElementById("preset_number").value;
        send_visca_request(request)
            .then((response) => {
                console.log('Set preset ' + request['value']);
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed set preset: ' + a_error;
            });
    }

    function do_move() {
        request = {};
        request['command'] = 'moveto';
        request['pan'] = document.getElementById("pan_val").value;
        request['tilt'] = document.getElementById("tilt_val").value;
        request['zoom'] = document.getElementById("zoom_val").value;

        send_visca_request(request)
            .then((response) => {
                console.log('Moved ');
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed move: ' + a_error;
            });
    }

    function do_send_raw() {
        request = {};
        request['command'] = 'send_raw';
        request['bytes-to-send'] = document.getElementById("bytes_to_send").value;
        request['reply-length'] = document.getElementById("reply_length").value;

        send_visca_request(request)
            .then((response) => {
                console.log('Sent bytes');
                document.getElementById("showResults").innerHTML = response['response-bytes'];
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed move: ' + a_error;
            });
    }

    // Fetch all presets and save to a file
    function do_save_presets() {
        // Disable controls while we run
        document.getElementById("hideable_fields").style.visibility = "hidden";
        presets = [];
        do_get_next_preset(0)
    }

    function do_get_next_preset(a_preset_number) {
        request = {};
        request['command'] = 'go-preset';
        request['value'] = a_preset_number;
        send_visca_request(request)
            .then((response) => {
                console.log('Got preset ' + request['value']);
                // Wait for the camera to move before reading its position
                presetTimer = window.setTimeout(on_save_preset_timer, wait_for_preset, a_preset_number);
            })
            .catch((a_error) => {
                // TODO: See if and how the camera complains about an out of
                // range preset number.
                // If a_preset_number number is 0, try again with 1.
                // For any other value, save results to a JSON file (see below)
                document.getElementById("showResults").innerHTML = 'Failed get preset: ' + a_error;
                window.clearTimeout(presetTimer);
                presetTimer = null;
                document.getElementById("hideable_fields").style.visibility = "visible";
            });
    }

    function save_preset_file(a_content, a_fileName, a_contentType) {
        var a = document.createElement("a");
        var file = new Blob([a_content], {type: a_contentType});
        a.href = URL.createObjectURL(file);
        a.download = a_fileName;
        a.click();
        document.getElementById("showResults").innerHTML = 'Processing of presets complete';
    }

    function on_save_preset_timer(a_preset_number) {
        // Read the camera's position and zoom
        presetTimer = null;
        request = {};
        request['command'] = 'report';
        send_visca_request(request)
            .then((response) => {
                // Save the info for this preset
                var pre = {"preset":a_preset_number,
                           "pan":response['pan'],
                           "tilt":response['tilt'],
                           "zoom":response['zoom']};
                presets.push(pre);

                // Set the next preset
                if (a_preset_number < 3) {
                    document.getElementById("showResults").innerHTML = 'Processing preset ' + a_preset_number;
                    do_get_next_preset(a_preset_number+1);
                }
                else {
                    // Sanity check exit
                    console.log(presets);

                    document.getElementById("hideable_fields").style.visibility = "visible";
                    json_string = JSON.stringify(presets, null, 4);
                    save_preset_file(json_string, 'camera_data.json', 'text/plain');
                }
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed read position: ' + a_error;
                document.getElementById("hideable_fields").style.visibility = "visible";
            });
    }

    // Load all presets from a file
    // Button wraps the ugly (and now hidden) file-selection control
    function do_load_presets() {
        fileElem = document.getElementById('preset_file');
        if (fileElem) {
            fileElem.click();
        }
    }

    function uploadPresetFile(a_files) {
        const selectedFile = a_files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            presets = JSON.parse(evt.target.result);
            document.getElementById("hideable_fields").style.visibility = "hidden";
            do_move_to_next_preset(0);
        };
        reader.readAsText(selectedFile);
    }

    // Move to the position specified by presets[a_preset_index]
    function do_move_to_next_preset(a_preset_index) {
        request = {};
        request['command'] = 'moveto';
        request['pan']  = presets[a_preset_index].pan;
        request['tilt'] = presets[a_preset_index].tilt;
        request['zoom'] = presets[a_preset_index].zoom;
        document.getElementById("showResults").innerHTML = 'Loading preset ' + presets[a_preset_index].preset;
        send_visca_request(request)
            .then((response) => {
                console.log('Moved to preset[' + a_preset_index + ']');
                // Wait for the camera to move before saving as preset
                presetTimer = window.setTimeout(on_load_preset_timer, wait_for_preset, a_preset_index);
            })
            .catch((a_error) => {
                document.getElementById("showResults").innerHTML = 'Failed move: ' + a_error;
                document.getElementById("hideable_fields").style.visibility = "visible";
                window.clearTimeout(presetTimer);
                presetTimer = null;
            });
    }

    function on_load_preset_timer(a_preset_index) {
        // Set a camera preset
        presetTimer = null;
        request = {};
        request['command'] = 'set-preset';
        request['value'] = presets[a_preset_index].preset;
        send_visca_request(request)
            .then((response) => {
                console.log('Loaded preset ' + request['value']);
                a_preset_index = a_preset_index + 1;
                if (a_preset_index < presets.length) {
                    document.getElementById("showResults").innerHTML = 'Loaded preset ' + request['value'];
                    do_move_to_next_preset(a_preset_index);
                }
                else {
                    document.getElementById("hideable_fields").style.visibility = "visible";
                    document.getElementById("showResults").innerHTML = 'Finished loading presets'
                }
            })
            .catch((a_error) => {
                document.getElementById("hideable_fields").style.visibility = "visible";
                document.getElementById("showResults").innerHTML = 'Failed set preset: ' + a_error;
            });
    }
    </script>
</head>

<style>
    .arrow {
        color: white;
    }
    .arrow:hover {
        color: #A0A0A0;
    }
    .arrow:active {
        color: #707070;
    }

    .cls-1 {
        fill:none;
        stroke:#FFFFFF;
        stroke-linecap:round;
        stroke-linejoin:round;
        stroke-width:4px;
    }
</style>

<body>

<div id="showResults">
    results
</div>

<div id="hideable_fields" style="position:relative; top:0px; left:0px;">
    <br><br>
    <label for="camera">Camera address:</label>
    <input id="camera" type="number" value="1">
    &nbsp;&nbsp;<button onclick="do_read_version_info()">Read Camera Info</button>
    &nbsp;&nbsp;<button onclick="do_read_position()">Read Position</button>
    <br><br>
    <label for="pan_val">Pan:</label>
    <input id="pan_val" type="number" value="1">
    <label for="tilt_val">Tilt:</label>
    <input id="tilt_val" type="number" value="1">
    <label for="zoom_val">Zoom:</label>
    <input id="zoom_val" type="number" value="1">
    <button onclick="do_move()">Move to</button>
    <br><br>
    <label for="preset_number">Preset Number:</label>
    <input id="preset_number" type="number" value="1">
    <button onclick="do_show_preset()">Show Preset</button>
    <button onclick="do_set_preset()">Set Preset</button>
    <button onclick="do_save_presets()">Save Presets...</button>
    <button onclick="do_load_presets()">Load Presets...</button>
    <input type="file" id="preset_file" style="display:none" accept=".json,.txt,.xml" onchange="uploadPresetFile(this.files);">
    <br><br>
    <label for="bytes_to_send">Bytes to send:</label>
    <input id="bytes_to_send" type="text">
    <label for="reply_length">response bytes expected:</label>
    <input id="reply_length" type="number" value="0">
    <button onclick="do_send_raw()">Send raw bytes</button>

<!----------------- Pan/Tilt/Zoom buttons ----------------------->
<div style="position:relative; top:100px; left:100px; width:200px; height:100px; background:#3A393A;">
<div style="position:absolute; top:0px; left:38px; width:22px; height:19px;">
    <svg id="slew_up" class="arrow" width="22" height="19"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 19  L 11 0  L 22 19  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:19px; left:38px; width:22px; height:19px;">
    <svg id="jog_up" class="arrow" width="22" height="19"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 19  L 11 0  L 22 19  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:38px; left:0px; width:19px; height:22px;">
    <svg id="slew_left" class="arrow" width="19" height="22"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 19 22  L 0 11  L 19 0  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:38px; left:19px; width:19px; height:19px;">
    <svg id="jog_left" class="arrow" width="19" height="22"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 19 22  L 0 11  L 19 0  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:39px; left:39px; width:20px; height:20px;">
    <!-- Pan/tilt (crossed double-headed arrows) image -->
    <svg class="cls-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 54.3 53">
       <polyline points="12.43 18.83 1.5 23.23 5.9 34.17"/>
       <polyline points="41.87 18.83 52.8 23.23 48.4 34.17"/>
       <path     d="M1.5,23.66 q25,11.36,50,0"/>
       <polyline points="35.48 43.17 27.15 51.5 18.82 43.17"/>
       <polyline points="18.82 9.83 27.15 1.5 35.48 9.83"/>
       <polyline points="27.15 51.5 27.15 32.06 27.15 20.94 27.15 1.5"/>
    </svg>
</div>
<div style="position:absolute; top:38px; left:60px; width:19px; height:22px;">
    <svg id="jog_right" class="arrow" width="19" height="22"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 19 11  L 0 22  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:38px; left:79px; width:19px; height:22px;">
    <svg id="slew_right" class="arrow" width="19" height="22"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 19 11  L 0 22  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:60px; left:38px; width:22px; height:19px;">
    <svg id="jog_down" class="arrow" width="22" height="19"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 11 19  L 22 0  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:79px; left:38px; width:22px; height:19px;">
    <svg id="slew_down" class="arrow" width="22" height="19"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 11 19  L 22 0  Z" fill="currentColor"/>
    </svg>
</div>

<!----------------- Zoom buttons ----------------------->
<div style="position:absolute; top:0px; left:138px; width:22px; height:19px;">
    <svg id="slew_in" class="arrow" width="22" height="19"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 19  L 11 0  L 22 19  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:19px; left:138px; width:22px; height:19px;">
    <svg id="jog_in" class="arrow" width="22" height="19"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 19  L 11 0  L 22 19  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:39px; left:138px; width:20px; height:20px;">
    <!-- Zoom (magnifying glass) image -->
    <svg class="cls-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
        <circle cx="45" cy="47" r="35" fill="transparent" stroke-width="8" />
        <line x1="70" y1="70" x2="90" y2="90" stroke-width="12" />
    </svg>
</div>
<div style="position:absolute; top:60px; left:138px; width:22px; height:19px;">
    <svg id="jog_out" class="arrow" width="22" height="19"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 11 19  L 22 0  Z" fill="currentColor"/>
    </svg>
</div>
<div style="position:absolute; top:79px; left:138px; width:22px; height:19px;">
    <svg id="slew_out" class="arrow" width="22" height="19"
        onmousedown="on_mousedown(this);" onmouseup="on_mouseup(this);" onmouseleave="on_mouseleave(this);">
        <path d="M 0 0  L 11 19  L 22 0  Z" fill="currentColor"/>
    </svg>
</div>
</div>
</div>

</body>
</html>
